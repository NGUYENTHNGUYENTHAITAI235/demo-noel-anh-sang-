<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOEL V2</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: 'Times New Roman', serif;
}
#canvas-container {
    width: 100vw;
    height: 100vh;
}
#loader {
    position: fixed;
    inset: 0;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 100;
}
.spinner {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(255,215,150,.2);
    border-top: 2px solid #ffd966;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
#ui-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 40px;
}
.upload-wrapper {
    pointer-events: auto;
}
.upload-btn {
    border: 1px solid #d4af37;
    color: #d4af37;
    padding: 10px 24px;
    background: rgba(0,0,0,.4);
    cursor: pointer;
    font-size: 12px;
    letter-spacing: 2px;
}
#music-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 18px;
    color: #d4af37;
    cursor: pointer;
    pointer-events: auto;
}
#file-input { display:none; }
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
    "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
  }
}
</script>
</head>

<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="color:#d4af37; margin-top:16px">Loading Holiday Magic</div>
</div>

<div id="canvas-container"></div>

<div id="ui-layer">
    <div class="upload-wrapper">
        <label class="upload-btn">
            ThÃªm áº£nh
            <input id="file-input" type="file" accept="image/*" multiple>
        </label>
    </div>
    <div id="music-btn">ðŸ”Š</div>
</div>

<!-- ðŸŽµ NHáº C Ná»€N -->
<audio id="bg-music" loop>
    <source src="./in-love.mp3" type="audio/mpeg">
</audio>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

/* ===== MUSIC ===== */
const bgMusic = document.getElementById('bg-music');
const musicBtn = document.getElementById('music-btn');
let musicStarted = false;

function startMusic() {
    if (musicStarted) return;
    musicStarted = true;
    bgMusic.volume = 0;
    bgMusic.play().then(() => {
        let v = 0;
        const fade = setInterval(() => {
            v += 0.02;
            bgMusic.volume = Math.min(v, 0.5);
            if (v >= 0.5) clearInterval(fade);
        }, 100);
    }).catch(()=>{});
}
window.addEventListener('click', startMusic, { once:true });
window.addEventListener('keydown', startMusic, { once:true });

musicBtn.onclick = () => {
    if (bgMusic.paused) {
        bgMusic.play();
        musicBtn.textContent = 'ðŸ”Š';
    } else {
        bgMusic.pause();
        musicBtn.textContent = 'ðŸ”‡';
    }
};

/* ===== THREE BASIC ===== */
let scene, camera, renderer, composer;
const container = document.getElementById('canvas-container');

scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
camera.position.z = 50;

renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
container.appendChild(renderer.domElement);

composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
composer.addPass(new UnrealBloomPass(
    new THREE.Vector2(innerWidth, innerHeight),
    0.6, 0.4, 0.85
));

/* ===== OBJECTS ===== */
const group = new THREE.Group();
scene.add(group);

const geo = new THREE.BoxGeometry(1,1,1);
const mat = new THREE.MeshStandardMaterial({ color:0xffd966 });
for(let i=0;i<200;i++){
    const m = new THREE.Mesh(geo, mat);
    m.position.set(
        (Math.random()-0.5)*15,
        (Math.random()-0.5)*20,
        (Math.random()-0.5)*15
    );
    group.add(m);
}

scene.add(new THREE.AmbientLight(0xffffff,0.8));

/* ===== IMAGE UPLOAD ===== */
document.getElementById('file-input').addEventListener('change', e=>{
    [...e.target.files].forEach(f=>{
        const reader = new FileReader();
        reader.onload = ev=>{
            const tex = new THREE.TextureLoader().load(ev.target.result);
            const p = new THREE.Mesh(
                new THREE.PlaneGeometry(3,3),
                new THREE.MeshBasicMaterial({ map: tex })
            );
            p.position.set(
                (Math.random()-0.5)*10,
                (Math.random()-0.5)*10,
                (Math.random()-0.5)*10
            );
            group.add(p);
        };
        reader.readAsDataURL(f);
    });
});

/* ===== ANIMATE ===== */
function animate(){
    requestAnimationFrame(animate);
    group.rotation.y += 0.002;
    composer.render();
}
animate();

/* ===== LOADER ===== */
setTimeout(()=>{
    document.getElementById('loader').remove();
    startMusic();
},800);

window.addEventListener('resize',()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
    composer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
